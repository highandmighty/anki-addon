<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="./datatables.min.css">
  <link rel="stylesheet" href="./anki-table.css">
</head>
<body>

  <!-- Your table -->
  <div class="page">
    <table id="anki" class="display" style="width:100%"></table>
  </div>

  <!-- jQuery + DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="./datatables.min.js"></script>

  <script>
    const copyIcon = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z"/>
        </svg>`;

    const htmlIcon = `
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-code-square" viewBox="0 0 16 16">
        <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
        <path d="M6.854 4.646a.5.5 0 0 1 0 .708L4.207 8l2.647 2.646a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 0 1 .708 0m2.292 0a.5.5 0 0 0 0 .708L11.793 8l-2.647 2.646a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708 0"/>
      </svg>
    `

    const fieldRow = (label, value, rtl=false, format='text') => {
      const icon = format === 'html' ? htmlIcon : copyIcon;
      const iconLabel = format === 'html' ? 'Copy HTML' : 'Copy text';
      return `
      <tr>
        <td>
          <button type="button" class="copy-btn" title="${iconLabel}" data-format="${format}" data-label="${label}">
            <b>${label}</b>
            ${icon}
          </button>
        </td>
        <td class="${rtl ? 'rtl' : ''}">${value ?? ''}</td>
      </tr>`;
    };

    function format(row) {
      return `
        <table cellpadding="5" cellspacing="0" border="0" class="row-table nospan">
          ${fieldRow('Word', row.fields?.[0], true)}
          ${fieldRow('Niqqud', row.fields?.[1], true)}
          ${fieldRow('Transcription', row.fields?.[2])}
          ${fieldRow('Translation', row.fields?.[3], false, 'html')}
          ${fieldRow('Root', row.fields?.[4], true)}
          ${fieldRow('Root Meaning', row.fields?.[5])}
          ${fieldRow('Example', row.fields?.[7], true)}
          ${fieldRow('Notes', row.fields?.[6], false, 'html')}
          ${fieldRow('Notetype', row.notetype)}
        </table>`;
    }

    fetch('./anki-table.json').then(r => r.json()).then(data => {
      const table = $('#anki').DataTable({
        data,
        columns: [
          { data: null, className: 'details-control', orderable: false, defaultContent: '', width: 50 },
          { data: 'fields.3', title: 'Translation', width: 340 },
          { data: 'fields.0', title: 'Word', width: 300 },
          {
            data: null,
            title: 'Modified',
            width: 250,
            render: (row, type) => {
              const ts = +row.modified;
              if (type === 'sort' || type === 'type') return ts;
              return new Date(ts * 1000).toISOString().slice(0,10);
            }
          }
        ],
        order: [[3, 'desc']],
        pageLength: 50,
        responsive: true,
        columnDefs: [
          { targets: [2, 3], className: 'rtl dt-body-right' }, // choose columns
          { targets: '_all', className: 'align-top' }
        ]
      });

      // toggle child rows
      $('#anki tbody').on('click', 'td.details-control', function () {
        const tr = $(this).closest('tr');
        const row = table.row(tr);
        if (row.child.isShown()) {
          row.child.hide();
          tr.removeClass('shown');
        } else {
          row.child(format(row.data())).show();
          tr.addClass('shown');
        }
      });

      $('#anki tbody').on('click', '.copy-btn', function () {
        const valueCell = $(this).closest('tr').find('td').eq(1)[0];
        const format = this.dataset.format === 'html' ? 'html' : 'text';
        const fieldname = this.dataset.label;
        const replaceFields = ["Word", "Niqqud"];
        let text;
        if (format === 'html') {
          text = (valueCell?.innerHTML || '').trim();
        } else {
          text = (valueCell?.innerText || '').trim();
        }
        if (replaceFields.includes(fieldname)) {
          text = text.replaceAll(" /", ",");
        }
        navigator.clipboard.writeText(text).then(() => {
          this.classList.add('copied');
          setTimeout(() => this.classList.remove('copied'), 500);
        });
      });
    });
  </script>
</body>
</html>

